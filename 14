"""
Модуль для поиска анаграмм в тексте.

Анаграмма - слова, составленные из одних и тех же букв в разном порядке.
Примеры: "кот"-"ток", "listen"-"silent", "Азора"-"роза".

Основные функции:
    find_anagrams_in_text(text) - главная функция поиска
    clean_text(text) - очистка текста
    normalize_word(word) - нормализация слова
    get_unique_words(text) - извлечение уникальных слов
    group_anagrams(words) - группировка анаграмм

Особенности:
    - Поддержка русского и английского языков
    - Игнорирование регистра и знаков препинания
    - Удаление дубликатов и однобуквенных слов
    - Обработка краевых случаев

Разработано с использованием нисходящего проектирования.
Версия: 4.0 (Production-ready)
Автор: [Ваше Имя]
Дата: 2024-01-15
"""

import re
from collections import defaultdict


def find_anagrams_in_text(text):
    """
    Находит все группы анаграмм во входном тексте.
    
    Алгоритм:
        1. Проверка и валидация входных данных
        2. Очистка текста от не-буквенных символов
        3. Извлечение уникальных слов длиной > 1 символа
        4. Группировка слов по их нормализованной форме
        5. Фильтрация и сортировка результатов
    
    Args:
        text (str): Входной текст для анализа. Может содержать
                   знаки препинания, смешанный регистр, пробелы.
                   Пример: "Кот, ток! КТО? Отк."
        
    Returns:
        list: Массив групп анаграмм, где каждая группа - 
              отсортированный список слов-анаграмм.
              
              Пример возвращаемого значения:
              [['кот', 'кто', 'ток'], ['listen', 'silent']]
    
    Raises:
        Не вызывает исключений. При некорректных входных данных
        возвращает пустой список.
    
    Примеры:
        >>> find_anagrams_in_text("кот ток кто")
        [['кот', 'кто', 'ток']]
        
        >>> find_anagrams_in_text("")
        []
        
        >>> find_anagrams_in_text(123)  # Не строка
        []
    
    Notes:
        - Однобуквенные слова игнорируются
        - Регистр не имеет значения
        - Дубликаты слов удаляются
        - Знаки препинания игнорируются
    
    Сложность:
        Время: O(N × M × log M), где:
            N - количество слов в тексте
            M - средняя длина слова
            log M - сортировка букв в слове
        Память: O(N × M) для хранения групп анаграмм
    """
    # Проверка входных данных: защита от None, нестроковых типов
    if not text or not isinstance(text, str):
        return []  # Возвращаем пустой список вместо исключения
    
    # 1. Очистка: удаляем всё, кроме букв и пробелов
    cleaned_text = clean_text(text)
    
    # 2. Извлечение слов: уникальные, длиной > 1
    words = get_unique_words(cleaned_text)
    
    # 3. Группировка: создаем словарь {нормализованная_форма: [слова]}
    anagram_groups = group_anagrams(words)
    
    return anagram_groups


def clean_text(text):
    """
    Очищает текст: приводит к нижнему регистру и удаляет знаки препинания.
    
    Использует регулярное выражение для удаления всех символов,
    кроме букв (русских/английских) и пробелов.
    
    Args:
        text (str): Исходный текст, возможно с знаками препинания,
                   цифрами, специальными символами.
                   Пример: "Cat, 123 dog! Мяу?"
        
    Returns:
        str: Очищенный текст в нижнем регистре, где все не-буквенные
             символы заменены на пробелы. Лишние пробелы не удаляются,
             так как они будут обработаны функцией split() позже.
    
    Регулярное выражение:
        [^a-zA-Zа-яА-ЯёЁ\s] - все символы, КРОМЕ:
            a-z: английские строчные буквы
            A-Z: английские прописные буквы
            а-я: русские строчные буквы
            А-Я: русские прописные буквы
            ёЁ: русские буквы ё (важно отдельно, т.к. не входят в а-я)
            \s: пробельные символы (пробел, табуляция, новая строка)
    
    Примеры:
        >>> clean_text("Cat, dog! Мяу? 123")
        'cat  dog  мяу   '
        
        >>> clean_text("А роза упала на лапу Азора")
        'а роза упала на лапу азора'
        
        >>> clean_text("Hello, world! Привет, мир!")
        'hello  world  привет  мир '
    
    Notes:
        - Цифры удаляются
        - Подчеркивания, дефисы удаляются
        - Множественные пробелы сохраняются
    """
    # Удаляем всё, кроме букв и пробелов
    text = re.sub(r'[^a-zA-Zа-яА-ЯёЁ\s]', ' ', text)
    # Приводим к нижнему регистру и обрезаем пробелы по краям
    return text.lower().strip()


def normalize_word(word):
    """
    Нормализует слово для сравнения анаграмм.
    
    Создает каноническую форму слова путем сортировки его букв
    в алфавитном порядке. Два слова являются анаграммами тогда и
    только тогда, когда их нормализованные формы совпадают.
    
    Args:
        word (str): Слово для нормализации. Предполагается, что
                   слово уже очищено (только буквы, нижний регистр).
                   Пример: "кот", "listen"
        
    Returns:
        str: Нормализованная форма слова - буквы, отсортированные
             по алфавиту. Пример: "кот" → "кот", "ток" → "кот"
    
    Математическая основа:
        f(word) = sorted(letters(word))
        word1 ≡ word2 (анаграммы) ⇔ f(word1) = f(word2)
    
    Примеры:
        >>> normalize_word("кот")
        'кот'
        >>> normalize_word("ток")
        'кот'
        >>> normalize_word("listen")
        'eilnst'
        >>> normalize_word("silent")
        'eilnst'
        >>> normalize_word("Азора")
        'азор'
        >>> normalize_word("роза")
        'азор'
    
    Notes:
        - Сортировка выполняется по кодам Unicode
        - Для русского и английского алфавитов работает корректно
        - Для смешанных языков также работает
    
    Сложность:
        O(M log M), где M - длина слова (из-за сортировки)
    
    Альтернативы:
        Можно использовать подсчет букв через Counter (O(M)),
        но сортировка проще и достаточно эффективна для слов
        разумной длины (до 20 символов).
    """
    return ''.join(sorted(word))


def get_unique_words(text):
    """
    Извлекает уникальные слова из текста.
    
    Фильтрует слова по длине (> 1 символа) и удаляет дубликаты.
    Использует set для эффективной проверки уникальности (O(1)).
    
    Args:
        text (str): Очищенный текст (только буквы, пробелы,
                   нижний регистр). Пример: "кот кот собака а"
        
    Returns:
        list: Список уникальных слов длиной более 1 символа,
              в порядке первого появления в тексте.
    
    Алгоритм:
        1. Разбить текст на слова по пробелам
        2. Для каждого слова:
           - Проверить длину (> 1)
           - Проверить уникальность (через set)
           - Добавить в результат, если условия выполнены
    
    Примеры:
        >>> get_unique_words("кот кот собака а а б")
        ['кот', 'собака', 'б']
        
        >>> get_unique_words("hello hello world")
        ['hello', 'world']
        
        >>> get_unique_words("а б в")  # все слова однобуквенные
        []
    
    Notes:
        - Сохраняет порядок первого вхождения
        - Чувствителен к регистру (но текст уже в нижнем регистре)
        - "б" считается допустимым (2 буквы в Unicode)
    
    Сложность:
        O(N), где N - количество слов в тексте
        Использование set дает O(1) для проверки наличия
    """
    # Разбиваем на слова
    words = text.split()
    
    # Собираем уникальные слова длиной > 1
    unique_words = []
    seen = set()  # Для быстрой проверки уникальности
    
    for word in words:
        # Игнорируем однобуквенные слова и дубликаты
        if len(word) > 1 and word not in seen:
            seen.add(word)
            unique_words.append(word)
    
    return unique_words


def group_anagrams(words):
    """
    Группирует слова по анаграммам.
    
    Использует словарь для группировки слов с одинаковой
    нормализованной формой. Возвращает только группы с
    более чем одним словом.
    
    Args:
        words (list): Список слов для группировки.
                     Предполагается, что слова уникальны
                     и длиной > 1 символа.
                     Пример: ["кот", "ток", "кто", "собака"]
        
    Returns:
        list: Отсортированный список групп анаграмм.
              Каждая группа - отсортированный список слов.
              Группы сортируются по первому слову.
    
    Структура данных:
        Используется defaultdict(list), который автоматически
        создает пустой список при обращении к несуществующему ключу.
    
    Алгоритм:
        1. Для каждого слова вычисляем ключ (нормализованная форма)
        2. Добавляем слово в список по этому ключу
        3. Фильтруем: оставляем только списки с >1 элемента
        4. Сортируем слова внутри каждой группы
        5. Сортируем группы по первому слову
    
    Примеры:
        >>> group_anagrams(["кот", "ток", "кто", "собака"])
        [['кот', 'кто', 'ток']]
        
        >>> group_anagrams(["listen", "silent", "enlist", "dog"])
        [['enlist', 'listen', 'silent']]
        
        >>> group_anagrams(["кот", "собака"])  # нет анаграмм
        []
    
    Notes:
        - Возвращает только группы из 2+ слов
        - Слова в группах отсортированы лексикографически
        - Группы отсортированы по первому слову
    
    Сложность:
        O(N × M log M) - где N слов, M - длина (нормализация)
        + O(K log K) - сортировка результатов
        где K - количество найденных групп
    """
    # Словарь для группировки: ключ - нормализованная форма
    anagram_dict = defaultdict(list)
    
    # Группируем слова по нормализованной форме
    for word in words:
        key = normalize_word(word)
        anagram_dict[key].append(word)
    
    # Фильтруем и сортируем результат
    result = []
    for group in anagram_dict.values():
        # Только группы с более чем одним словом
        if len(group) > 1:
            # Сортируем слова внутри группы
            result.append(sorted(group))
    
    # Сортируем группы по первому слову
    result.sort(key=lambda x: x[0])
    
    return result


def main():
    """
    Основная функция для демонстрации работы алгоритма.
    
    Запускает серию тестовых сценариев для проверки:
    1. Простые случаи
    2. Разные языки
    3. Знаки препинания
    4. Краевые случаи
    5. Комплексный пример
    
    Используется как демонстрация, так и встроенное тестирование.
    При запуске файла напрямую выводит результаты всех тестов.
    
    Returns:
        None: Функция только выводит результаты в консоль.
    
    Пример запуска:
        $ python anagram_finder.py
        ======================================================================
        ТЕСТИРОВАНИЕ ПОИСКА АНАГРАММ В ТЕКСТЕ
        ======================================================================
        ...
    
    Notes:
        - Тесты покрывают основные и краевые случаи
        - Каждый тест сопровождается описанием ожидаемого результата
        - Результаты форматируются для удобства чтения
    """
    # Набор тестовых текстов с описаниями
    test_texts = [
        # 1. Простой пример - базовый случай
        ("кот ток кто отк тко", 
         "Ожидается 1 группа из 5 слов"),
        
        # 2. Русский язык - разные анаграммы
        ("лист столи тсил истл",
         "Ожидается 1 группа из 4 слов"),
        
        # 3. Английский язык - классические анаграммы
        ("listen silent enlist tinsel",
         "Ожидается 1 группа из 4 слов"),
        
        # 4. Знаки препинания - проверка очистки
        ("cat, tac! act? atc.",
         "Ожидается 1 группа из 4 слов"),
        
        # 5. Палиндром и анаграммы - литературный пример
        ("А роза упала на лапу Азора",
         "Ожидается 1 группа: ['азора', 'роза']"),
        
        # 6. Смешанный текст - несколько групп
        ("Hello world! drawer reward redraw warder",
         "Ожидается 1 группа: ['drawer', 'redraw', 'reward', 'warder']"),
        
        # 7. Пустой текст - краевой случай
        ("",
         "Ожидается 0 групп"),
        
        # 8. Текст без анаграмм
        ("Это тестовый текст без анаграмм",
         "Ожидается 0 групп"),
        
        # 9. Однобуквенные слова - должны игнорироваться
        ("а б в а б в",
         "Ожидается 0 групп (все слова однобуквенные)"),
        
        # 10. Дубликаты слов - должны удаляться
        ("кот кот ток ток кто кто",
         "Ожидается 1 группа из 3 уникальных слов"),
    ]
    
    print("=" * 70)
    print("ТЕСТИРОВАНИЕ ПОИСКА АНАГРАММ В ТЕКСТЕ")
    print("=" * 70)
    
    # Запуск всех тестов
    for i, (text, description) in enumerate(test_texts, 1):
        print(f"\n{'─' * 70}")
        print(f"ТЕСТ #{i:02d}: {description}")
        print(f"{'─' * 70}")
        
        if text:
            # Показываем первые 50 символов текста
            display_text = text if len(text) <= 50 else text[:47] + "..."
            print(f"Входной текст: '{display_text}'")
        else:
            print("Входной текст: (пустая строка)")
        
        # Выполняем поиск анаграмм
        anagrams = find_anagrams_in_text(text)
        
        # Выводим результаты
        if anagrams:
            print(f"✓ Найдено групп анаграмм: {len(anagrams)}")
            for j, group in enumerate(anagrams, 1):
                print(f"  Группа {j}: {group}")
        else:
            print("✗ Анаграммы не найдены")
    
    # Демонстрационный комплексный пример
    print(f"\n{'=' * 70}")
    print("КОМПЛЕКСНЫЙ ДЕМОНСТРАЦИОННЫЙ ПРИМЕР")
    print(f"{'=' * 70}")
    
    demo_text = """
    Кот ток кто отк. Listen silent enlist tinsel.
    Drawer reward redraw warder. Азора роза.
    Python типон photon. Triangle integral.
    """
    
    print(f"Текст:\n{demo_text}")
    print("Результат поиска анаграмм:")
    
    results = find_anagrams_in_text(demo_text)
    
    if results:
        total_words = sum(len(group) for group in results)
        print(f"Всего найдено {len(results)} групп, {total_words} слов:")
        for group in results:
            print(f"  • {group}")
    else:
        print("Анаграммы не найдены")
    
    print(f"\n{'=' * 70}")
    print("ТЕСТИРОВАНИЕ ЗАВЕРШЕНО")
    print("=" * 70)


# Точка входа в программу
if __name__ == "__main__":
    """
    Точка входа в программу.
    
    При прямом запуске файла (не при импорте):
    1. Запускается main() - демонстрация работы
    2. Выполняются все тестовые сценарии
    3. Выводятся результаты
    
    При импорте модуля:
    - Функции доступны для использования
    - main() не выполняется автоматически
    
    Примеры использования:
        1. Прямой запуск: python anagram_finder.py
        2. Импорт: from anagram_finder import find_anagrams_in_text
    """
    main()